# =================================================================
# BLOQUE HTTP (PUERTO 80) - Redirección a HTTPS
# Este bloque es esencialmente solo para recibir peticiones HTTP
# y redirigirlas a HTTPS, si este último funciona.
# =================================================================
server {
    listen 80;
    server_name taskflow-icontel.duckdns.org www.taskflow-icontel.duckdns.org;
    
    # Redirección 301 (Permanente) al mismo dominio en HTTPS
    # Si el 443 no funciona, comenta esta línea temporalmente.
    # return 301 https://$host$request_uri;
    
    # Configuración de Laravel (si no quieres la redirección)
    root /var/www/public;
    index index.php index.html;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    # Procesamiento PHP para el puerto 80 (si no hay redirección)
    location ~ \.php$ {
        fastcgi_pass app-fpm:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}


# =================================================================
# BLOQUE HTTPS (PUERTO 443) - Servidor Principal de Laravel
# Este es el bloque que usará los certificados dummy para arrancar.
# =================================================================
server {
    listen 443 ssl http2;
    server_name taskflow-icontel.duckdns.org www.taskflow-icontel.duckdns.org;

    # --- Archivos de Certificados (Debe ser la ruta montada) ---
    ssl_certificate /Taskflow-Icontel/taskflow-backend/nginx/certs/fullchain.pem; 
    ssl_certificate_key /Taskflow-Icontel/taskflow-backend/nginx/certs/privkey.pem;

    # --- Configuraciones de Seguridad SSL ---
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers on;

    # --- Configuración de Laravel ---
    root /var/www/public;
    index index.php index.html;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Procesamiento PHP para el puerto 443
    location ~ \.php$ {
        fastcgi_pass app-fpm:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # Bloque de seguridad (oculta archivos con .)
    location ~ /\. {
        deny all;
    }
}
