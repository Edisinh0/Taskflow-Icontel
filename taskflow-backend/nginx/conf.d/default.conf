# Primer bloque: Redirección de HTTP a HTTPS (puerto 80)
server {
    listen 80;
    listen [::]:80;

    # Nombres de dominio que se redirigen
    server_name taskflow-icontel.duckdns.org www.taskflow-icontel.duckdns.org;

    # Advertencia de Nginx: the "listen ... http2" directive is deprecated
    # Se ignora la redirección y la configuración http2 en este bloque.

    # Redirección 301 (permanente) a HTTPS
    return 301 https://$host$request_uri;
}

# Segundo bloque: Configuración principal HTTPS (puerto 443)
server {
    # El puerto 443 debe ser `ssl` para HTTPS y `http2` para habilitar HTTP/2
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # Nombres de dominio principales
    server_name taskflow-icontel.duckdns.org www.taskflow-icontel.duckdns.org;

    # --- Configuración SSL/TLS ---
    # ¡ESTAS LÍNEAS RESUELVEN TU ERROR CRÍTICO!
    # Asegúrate de que estos archivos existan en la carpeta del host que se mapea a /etc/nginx/certs
    ssl_certificate /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/privkey.pem;

    ssl_session_cache shared:SSL:10m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # --- Configuración de la Aplicación (Root) ---
    # La ruta raíz dentro del contenedor que corresponde a tu aplicación Laravel
    root /var/www/public;
    index index.php index.html;

    # Aumentar el tamaño máximo de subida para archivos grandes si es necesario
    client_max_body_size 100M;

    # --- Manejo de Solicitudes ---
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Proxy para PHP-FPM
    location ~ \.php$ {
        # La IP/nombre del servicio PHP-FPM en tu docker-compose.yml
        # Asume que tu servicio PHP se llama 'taskflow-php' o similar.
        fastcgi_pass taskflow-php:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }

    # Bloquear acceso a archivos sensibles de Laravel
    location ~ /\.env|composer\.json|package\.json|package\-lock\.json|yarn\.lock|storage {
        deny all;
        return 404;
    }

    # Optimización para archivos estáticos (opcional)
    location ~* \.(jpg|jpeg|gif|png|ico|css|js|woff2|woff|eot|ttf|otf|svg)$ {
        expires 30d;
        log_not_found off;
    }

    # Log de acceso y error
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;
}

# Tercer bloque: Servidor para IPv6 (Si necesitas manejar una dirección IP literal en lugar de los nombres de dominio)
# Este bloque puede ser innecesario si el primer y segundo bloque cubren todos los casos.
# Si el script 10-listen-on-ipv6-by-default.sh causó el error de "conflicting server name", elimínalo
# server {
#     listen [::]:80 default_server;
#     listen [::]:443 ssl http2 default_server;
#     # ... configuración idéntica al bloque 443 principal si es necesario ...
# }
